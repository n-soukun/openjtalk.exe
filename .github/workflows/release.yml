name: Release OpenJTalk

on:
  push:
    branches: [main, master]
    tags:
      - "v*"
  pull_request:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      tag_name:
        description: "Tag name for the release (e.g., v1.0.0)"
        required: true
        default: "v1.0.0"
      release_name:
        description: "Release name"
        required: true
        default: "OpenJTalk Release"
      prerelease:
        description: "Mark as pre-release"
        required: false
        default: false
        type: boolean

jobs:
  build-windows:
    name: Build Windows x64
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Setup MSVC environment
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Set Japanese Locale
        run: |
          Set-WinSystemLocale ja-JP
          Set-WinUILanguageOverride ja-JP
          [System.Console]::OutputEncoding = [System.Text.Encoding]::GetEncoding("shift_jis")
        shell: pwsh

      - name: Build OpenJTalk
        run: |
          Write-Host "Building for Windows..."
          Write-Host "Setting up Windows build environment..."

          $HtsEngineDir = "$env:GITHUB_WORKSPACE\lib\hts_engine_API-1.10"
          $OpenJTalkDir = "$env:GITHUB_WORKSPACE\lib\open_jtalk-1.11"
          $BinDir = "$env:GITHUB_WORKSPACE\bin"

          # Prepare bin directory
          if (!(Test-Path $BinDir)) {
            New-Item -ItemType Directory -Path $BinDir -Force
          }

          Write-Host "Building HTS Engine API for Windows..."
          Set-Location $HtsEngineDir
          cmd /c "chcp 932 >nul 2>&1 & set CFLAGS=/source-charset:shift_jis /execution-charset:shift_jis & nmake /f Makefile.mak"
          cmd /c "chcp 932 >nul 2>&1 & nmake /f Makefile.mak install"

          Write-Host "Building Open JTalk for Windows..."
          Set-Location $OpenJTalkDir
          cmd /c "chcp 932 >nul 2>&1 & set CFLAGS=/source-charset:shift_jis /execution-charset:shift_jis & nmake /f Makefile.mak"

          Write-Host "Copying Windows executable to bin directory..."
          Copy-Item "$OpenJTalkDir\bin\open_jtalk.exe" $BinDir

          Write-Host "Windows build completed successfully!"
        shell: pwsh

      - name: Prepare artifacts
        run: |
          $BinDir = "$env:GITHUB_WORKSPACE\bin"

          if (!(Test-Path "artifacts")) {
            New-Item -ItemType Directory -Path "artifacts" -Force
          }

          Copy-Item "$BinDir\open_jtalk.exe" "artifacts\"
          Copy-Item "LICENSE" "artifacts\"
          Copy-Item "Readme.md" "artifacts\"

          Write-Host "Artifacts prepared in ./artifacts/"
        shell: pwsh

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: openjtalk-windows-x64
          path: artifacts/
          retention-days: 7

  build-linux:
    name: Build Linux x64
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential autoconf automake libtool

      - name: Build OpenJTalk
        run: make build

      - name: Test executable
        run: make test
        continue-on-error: true

      - name: Prepare artifacts
        run: make prepare-artifacts

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: openjtalk-linux-x64
          path: artifacts/
          retention-days: 7

  build-macos:
    name: Build macOS x64
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          brew install autoconf automake libtool

      - name: Build OpenJTalk
        run: make build

      - name: Test executable
        run: make test
        continue-on-error: true

      - name: Prepare artifacts
        run: make prepare-artifacts

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: openjtalk-macos-x64
          path: artifacts/
          retention-days: 7

  create-release:
    name: Create Release
    needs: [build-windows, build-linux, build-macos]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: openjtalk-windows-x64
          path: release-assets/windows/

      - name: Download Linux artifacts
        uses: actions/download-artifact@v4
        with:
          name: openjtalk-linux-x64
          path: release-assets/linux/

      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: openjtalk-macos-x64
          path: release-assets/macos/

      - name: Create release archives
        run: |
          mkdir -p release-packages

          # Windows package
          cd release-assets/windows
          zip -r ../../release-packages/openjtalk-windows-x64.zip .
          cd ../..

          # Linux package
          cd release-assets/linux
          tar -czf ../../release-packages/openjtalk-linux-x64.tar.gz .
          cd ../..

          # macOS package
          cd release-assets/macos
          tar -czf ../../release-packages/openjtalk-macos-x64.tar.gz .
          cd ../..

          # List created packages
          ls -la release-packages/

      - name: Set release variables
        id: release_vars
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "tag_name=${{ github.event.inputs.tag_name }}" >> $GITHUB_OUTPUT
            echo "release_name=${{ github.event.inputs.release_name }}" >> $GITHUB_OUTPUT
            echo "prerelease=${{ github.event.inputs.prerelease }}" >> $GITHUB_OUTPUT
          else
            TAG_NAME=${GITHUB_REF#refs/tags/}
            echo "tag_name=${TAG_NAME}" >> $GITHUB_OUTPUT
            echo "release_name=OpenJTalk ${TAG_NAME}" >> $GITHUB_OUTPUT
            if [[ "${TAG_NAME}" =~ (alpha|beta|rc|pre) ]]; then
              echo "prerelease=true" >> $GITHUB_OUTPUT
            else
              echo "prerelease=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Generate release notes
        id: release_notes
        run: |
          cat > release_notes.md << 'EOF'
          ## OpenJTalk Release ${{ steps.release_vars.outputs.tag_name }}

          ### ðŸ“¦ Downloads

          | Platform | Architecture | Download |
          |----------|-------------|----------|
          | Windows  | x64         | [openjtalk-windows-x64.zip](https://github.com/${{ github.repository }}/releases/download/${{ steps.release_vars.outputs.tag_name }}/openjtalk-windows-x64.zip) |
          | Linux    | x64         | [openjtalk-linux-x64.tar.gz](https://github.com/${{ github.repository }}/releases/download/${{ steps.release_vars.outputs.tag_name }}/openjtalk-linux-x64.tar.gz) |
          | macOS    | x64         | [openjtalk-macos-x64.tar.gz](https://github.com/${{ github.repository }}/releases/download/${{ steps.release_vars.outputs.tag_name }}/openjtalk-macos-x64.tar.gz) |

          ### ðŸ› ï¸ Build Information

          - **Built with**: Multi-platform Makefile
          - **CI/CD**: GitHub Actions
          - **Commit**: ${{ github.sha }}
          - **Build date**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')

          ### ðŸ“‹ Usage

          1. Download the appropriate package for your platform
          2. Extract the archive
          3. Run the `open_jtalk` executable

          For detailed usage instructions, please refer to the [README](https://github.com/${{ github.repository }}/blob/main/Readme.md).

          ### ðŸ”„ Changes

          This release includes the latest changes from the main branch as of commit ${{ github.sha }}.

          ---

          **Full Changelog**: https://github.com/${{ github.repository }}/commits/${{ steps.release_vars.outputs.tag_name }}
          EOF

          echo "body<<EOF" >> $GITHUB_OUTPUT
          cat release_notes.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.release_vars.outputs.tag_name }}
          name: ${{ steps.release_vars.outputs.release_name }}
          body: ${{ steps.release_notes.outputs.body }}
          draft: false
          prerelease: ${{ steps.release_vars.outputs.prerelease }}
          files: |
            release-packages/openjtalk-windows-x64.zip
            release-packages/openjtalk-linux-x64.tar.gz
            release-packages/openjtalk-macos-x64.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  cleanup:
    name: Cleanup Artifacts
    needs: [build-windows, build-linux, build-macos, create-release]
    runs-on: ubuntu-latest
    if: always() && needs.create-release.result == 'success'

    steps:
      - name: Delete build artifacts
        uses: geekyeggo/delete-artifact@v5
        with:
          name: |
            openjtalk-windows-x64
            openjtalk-linux-x64
            openjtalk-macos-x64
        continue-on-error: true
